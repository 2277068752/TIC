{"version":3,"sources":["aegis.min.js"],"names":[],"mappings":";;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.js","sourcesContent":["/**\n * =============================================\n * @tencent/aegis-mp-sdk@1.11.1 (c) 2019 ivweb.\n * Author pumpkincai.\n * Released under the MIT License.\n * Thanks for supporting Aegis!\n * =============================================\n **/\n!function(e,t){\"object\"==typeof exports&&\"undefined\"!=typeof module?module.exports=t():\"function\"==typeof define&&define.amd?define(t):(e=e||self).Aegis=t()}(this,function(){var f,e,t,n,i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},r=function(){return(r=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},o=(s.prototype.indexOf=function(e,t){for(var n=0;n<e.length;n++)if(e[n].callback===t)return n;return-1},s.prototype.on=function(e,t,n){if(void 0===n&&(n=0),this){var i=this.__EventsList[e];if(i=i||(this.__EventsList[e]=[]),-1!==this.indexOf(i,t))return this;var r={name:e,type:n||0,callback:t};return i.push(r),this}},s.prototype.one=function(e,t){this.on(e,t,1)},s.prototype.remove=function(e,t){if(this){var n=this.__EventsList[e];if(!n)return null;if(!t){try{delete this.__EventsList[e]}catch(e){}return null}if(n.length){var i=this.indexOf(n,t);n.splice(i,1)}return this}},s);function s(){var s=this;this.emit=function(e,t){if(s){var n,i=s.__EventsList[e];if(i&&i.length){i=i.slice();for(var r=0;r<i.length;r++){n=i[r];try{var o=n.callback.apply(s,[t]);if(1===n.type&&s.remove(e,n.callback),!1===o)break}catch(e){throw e}}}return s}},this.__EventsList={}}function a(e){try{return encodeURIComponent(decodeURIComponent(e))}catch(e){return\"\"}}(n=f=f||{}).INFO_ALL=\"-1\",n.API_RESPONSE=\"1\",n.INFO=\"2\",n.ERROR=\"4\",n.PROMISE_ERROR=\"8\",n.AJAX_ERROR=\"16\",n.SCRIPT_ERROR=\"32\",n.IMAGE_ERROR=\"64\",n.CSS_ERROR=\"128\",n.CONSOLE_ERROR=\"256\",n.MEDIA_ERROR=\"512\",n.RET_ERROR=\"1024\",n.REPORT=\"2048\",(t=e=e||{})[t.number=-1]=\"number\",t.string=\"\";function u(e){try{return(JSON.stringify(e,(i=[],r=[],function(e,t){if(t instanceof Error)return\"Error.message【 \"+t.message+\" 】;  Error.stack【 \"+t.stack+\" 】\";if(\"object\"==typeof t&&null!==t){var n=i.indexOf(t);if(-1!==n)return\"[Circular \"+r[n]+\"]\";i.push(t),r.push(e||\"root\")}return t}),4)||\"undefined\").replace(/\"/gim,\"\")}catch(e){return\"error happen when aegis stringify: \\n \"+e.message+\" \\n \"+e.stack}var i,r}var c,l,p,h,g,d,m=[\"ret\",\"retcode\",\"code\"];function y(e,t){this.type=\"fetch\",this.data=e||{},this.data.response=t}function v(e){this.type=\"xhr\",this.data=e}Object.defineProperty(v.prototype,\"sourceURL\",{get:function(){return this.data.responseURL},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,\"status\",{get:function(){return Number(this.data.status)},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,\"headers\",{get:function(){var e=this.data.getAllResponseHeaders().split(\"\\n\"),r={};return e.forEach(function(e){if(e){var t=e.split(\": \"),n=t[0],i=t[1].trim();r[n]=i}}),r},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,\"sourceURL\",{get:function(){return this.data.url},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,\"status\",{get:function(){return Number(this.data.status)},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,\"headers\",{get:function(){var n={};return this.data.headers.forEach(function(e,t){n[t]=e}),n},enumerable:!0,configurable:!0}),(d=c=c||{})[d.android=1]=\"android\",d[d.ios=2]=\"ios\",d[d.other=100]=\"other\",(g=l=l||{})[g.oldX5=1]=\"oldX5\",g[g.newX5=2]=\"newX5\",g[g.other=3]=\"other\",(h=p=p||{})[h.unknown=100]=\"unknown\",h[h.wifi=1]=\"wifi\",h[h.net2g=2]=\"net2g\",h[h.net3g=3]=\"net3g\",h[h.net4g=4]=\"net4g\",h[h.net5g=5]=\"net5g\";var O=!(h[h.net6g=6]=\"net6g\"),b=[],_=[],w=[],R=!1;function P(n,i){var r;void 0===n&&(n=0);var o=[];return function(e,t){if(o.push(e),i&&o.length>=i)return t(o.splice(0,o.length)),void(r&&clearTimeout(r));r&&clearTimeout(r),r=setTimeout(function(){r=null,t(o.splice(0,o.length))},n)}}function S(e,t){return Array.isArray(e)?t(e.map(function(e){return{msg:\"string\"==typeof e.msg?e.msg:u(e.msg),level:e.level}})):t({msg:\"string\"==typeof e.msg?e.msg:u(e.msg),level:e.level})}var x=function(){};function E(n){if(!n||!n.reduce||!n.length)throw new TypeError(\"createPipeline 方法需要传入至少有一个 pipe 的数组\");return 1===n.length?function(e,t){n[0](e,t||x)}:n.reduce(function(n,i){return function(e,t){return void 0===t&&(t=x),n(e,function(e){return i&&i(e,t)})}})}var L=(j.prototype.init=function(e,t){var n=this;this.setConfig(e),j.installedPlugins.forEach(function(e){e.call(n,t)}),this.lifeCycle.emit(\"onInited\")},j.prototype.setConfig=function(e){return Object.assign(this.config,e),this.bean.id=this.config.id||\"\",this.bean.uin=this.config.uin||\"\",this.bean.version=this.config.version||0,this.lifeCycle.emit(\"onConfigChange\",e),this.config},j.prototype.extendBean=function(e,t){this.bean[e]=t},j.use=function(e){-1===j.installedPlugins.indexOf(e)&&j.installedPlugins.push(e)},j.prototype.send=function(e,t,n){throw new Error('You need to override \"send\" method')},j.prototype._sendSDKError=function(e){this.send({url:\"https://aegis.qq.com/collect?id=1085&msg[0]=\"+encodeURIComponent(u(e))+\"&level[0]=2&from=\"+this.config.id+\"&count=1&version=1.11.1\",addBean:!1,method:\"get\"})},j.prototype.info=function(e){this._normalLogPipeline({msg:e,level:f.INFO})},j.prototype.infoAll=function(e){this._normalLogPipeline({msg:e,level:f.INFO_ALL})},j.prototype.report=function(e){this._normalLogPipeline({msg:e,level:f.REPORT})},j.prototype.reportPv=function(e){e&&this.send({url:this.config.url+\"/\"+e,addBean:!1})},j.prototype.reportTime=function(e,t){\"string\"==typeof e?\"number\"==typeof t?this._submitCustomTime(e,t):console.warn(\"reportTime 的第二个参数必须为 number 类型哟\"):console.warn(\"reportTime 的第一个参数必须为开发者平台申请的 key 值\")},j.prototype.time=function(e){\"string\"==typeof e?this._timeMap[e]?console.warn(\"Timer \"+e+\" already exists\"):this._timeMap[e]=Date.now():console.warn(\"time 的第一个参数必须传入开发者平台申请到的 key 值\")},j.prototype.timeEnd=function(e){\"string\"==typeof e?this._timeMap[e]?(this._submitCustomTime(e,Date.now()-this._timeMap[e]),delete this._timeMap[e]):console.warn(\"Timer \"+e+\" does not exist\"):console.warn(\"timeEnd 的第一个参数必须传入开发者平台申请到的 key 值\")},j.prototype._submitCustomTime=function(e,t){this._customTimePipeline({name:e,duration:t})},j.installedPlugins=[],j);function j(e){var r=this;this.config={version:1,delay:1500,repeat:5,random:1,url:\"https://aegis.qq.com/collect\",speedUrl:\"https://aegis.qq.com/speed\",customTimeUrl:\"https://aegis.qq.com/speed/custom\",whiteListUrl:\"https://aegis.qq.com/aegis/whitelist\",performanceUrl:\"https://aegis.qq.com/speed/performance\"},this.lifeCycle=new o,this.bean={},this._normalLogPipeline=E([P(this.config.delay,5),function(e){var i=!1,r=!1;setTimeout(function(){e.send({url:e.config.whiteListUrl||\"\"},function(e){try{0===(e=JSON.parse(e)||{}).retcode&&(i=e.result.is_in_white_list)}catch(e){}r=!0},function(){r=!0})},50);var o=[];return function(e,t){if(i)t(e.concat(o.splice(0)).map(function(e){return e.level===f.INFO_ALL&&(e.level=f.INFO),e}));else{var n=e.filter(function(e){if(e.level!==f.INFO&&e.level!==f.API_RESPONSE)return e.level===f.INFO_ALL&&(e.level=f.INFO),!0;r||(o.push(e),200<=o.length&&(o.length=200))});n.length&&t(n)}}}(this),S,function(e,t){var n=r.config.beforeReport;if(\"function\"==typeof n&&(e=e.filter(function(e){return!1!==n(e)})),e.length){var i=JSON.parse(JSON.stringify(e));return r.lifeCycle.emit(\"beforeReport\",i),t(e)}},function(e){r.send({url:r.config.url||\"\",data:function(e){return(e=Array.isArray(e)?e:[e]).map(function(t,n){return Object.getOwnPropertyNames(t).map(function(e){return a(e)+\"[\"+n+\"]=\"+a(t[e])}).join(\"&\")}).join(\"&\")+(e.length?\"&count=\"+e.length:\"\")}(e),method:\"post\",contentType:\"application/x-www-form-urlencoded\"},function(){var t=r.config.onReport;\"function\"==typeof t&&e.forEach(function(e){t(e)})})}]),this._timeMap={},this._customTimePipeline=E([P(this.config.delay),function(e){r.send({url:r.config.customTimeUrl+\"?version=\"+r.config.version+\"&payload=\"+encodeURIComponent(JSON.stringify({custom:e}))})}])}function I(){try{var e=getCurrentPages();return(e[e.length-1]||{}).route||\"\"}catch(e){return\"\"}}function A(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(0===e.length)throw new TypeError(\"Cannot convert undefined or null to object\");for(var n=Object(e[0]),i=1;i<e.length;i++){var r=e[i];if(null!=r)for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(n[o]=r[o])}return n}function C(e,t){return\"\"+e==\"\"+t}Object.assign||Object.defineProperty(Object,\"assign\",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(null==e)throw new TypeError(\"Cannot convert first argument to object\");for(var t=Object(e),n=1;n<arguments.length;n++){var i=arguments[n];if(null!=i){i=Object(i);for(var r=Object.keys(Object(i)),o=0,s=r.length;o<s;o++){var f=r[o],a=Object.getOwnPropertyDescriptor(i,f);void 0!==a&&a.enumerable&&(t[f]=i[f])}}}return t}});function N(){var f=this;if(F.getFileSystemManager)try{var e=this.config,t=e.id,a=void 0===t?\"\":t,n=e.uin,u=void 0===n?0:n,i=e.url,c=void 0===i?\"\":i,l=new U({limit:this.config.offlineLogLime});this.lifeCycle.on(\"beforeReport\",function(e){void 0===e&&(e=[]),l.save2Offline(e,f.config)}),l.ready(function(t){t||f.send({url:c+\"/offlineAuto\"},function(e){var s=(e.data.toString().match(/window\\._badjsOfflineAuto\\('(.*)'\\)/)||[])[1];if(s){if(t)return;l.getLogs({id:a,uin:u},function(e,t,n,i){if(e)console.error(e);else{var r=A({logs:t,msgObj:n,urlObj:i,secretKey:s},{id:a,uin:u}),o=c+\"/offlineLog\";f.send({url:o,data:{offline_log:r},method:\"post\"},function(){l.clearLogs()})}})}})})}catch(f){console.error(f)}else console.warn(\"[aegis-mp-sdk]unsupport getFileSystemManager offline log not work!\")}var T,q,k,F=wx||qq,U=(X.prototype.checkLimit=function(o,s){void 0===s&&(s=function(){});var f=this.fileSystem,a=this._filePath,u=this.limitSize;f.readFile({filePath:a,encoding:\"utf8\",success:function(e){var t=e.data;if((t=t.toString()+o).length>u){for(var n=t.split(\"\\n\"),i=\"\",r=n.length-1;0<=r&&!(n[r]&&(i=n[r]+\"\\n\"+i).length>u);r--);f.writeFile({filePath:a,data:i,success:s})}else f.appendFile({data:o,filePath:a,encoding:\"utf8\",success:s,fail:function(e){console.error(e)}})}})},X.prototype.getLogs=function(p,r){var e=this.fileSystem,t=this._filePath;e.readFile({filePath:t,encoding:\"utf8\",fail:function(e){console.error(e)},success:function(e){var t=e.data,n=(void 0===t?\"\":t).toString().split(\"\\n\").filter(function(e){return e}).map(function(e){return JSON.parse(e)}),i=[],s={},f=[],a={},u=[],c=0,l=0;n&&(i=n.map(function(e){if(C(e.id,p.id)&&C(e.uin,p.uin)){var t=e.from,n=e.level,i=e.msg,r=e.time,o=e.version;return\"number\"!=typeof s[i]&&(f.push(i),s[i]=c++),\"number\"!=typeof a[t]&&(u.push(t),a[t]=l++),{f:a[t],l:n,m:s[i],t:r,v:o}}})),r(null,i,f,u)}})},X),D=F.request,M=(i(q=J,k=T=L),q.prototype=null===k?Object.create(k):(B.prototype=k.prototype,new B),Object.defineProperty(J.prototype,\"_bean\",{get:function(){var t=this;return Object.getOwnPropertyNames(this.bean).map(function(e){return e+\"=\"+t.bean[e]}).join(\"&\")+\"&from=\"+encodeURIComponent(I())},enumerable:!0,configurable:!0}),J.prototype._initOfflineLog=function(){J.use(N)},J.prototype.uploadLogs=function(e,t){void 0===e&&(e={}),void 0===t&&(t={}),this.lifeCycle.emit(\"uploadLogs\",e,t)},J.__version__=\"1.11.1\",J._sessionID=\"session-\"+Date.now(),J.asyncPluginIndex=0,J);function J(e){var i,o=T.call(this,e)||this;o._originRequest=D,o.send=function(e,t,n){if(e&&\"string\"==typeof e.url&&\"\"!==e.url&&o.bean.id){var i=e.url;if(o.config.whiteListUrl===i){var r=t;t=function(e){r&&r(JSON.stringify(e.data))}}!1!==e.addBean&&(i=i+(-1===i.indexOf(\"?\")?\"?\":\"&\")+o._bean),\"get\"===(e.method||\"get\").toLocaleLowerCase()?(i=function(e,n){if(\"string\"!=typeof e)return\"\";if(\"object\"==typeof n&&n){var t=Object.getOwnPropertyNames(n).map(function(e){var t=n[e];return e+\"=\"+(\"string\"==typeof t?encodeURIComponent(t):encodeURIComponent(JSON.stringify(t)))}).join(\"&\").replace(/eval/gi,\"evaI\");return e+(-1===e.indexOf(\"?\")?\"?\":\"&\")+t}return e}(i,e.data),o._originRequest({url:i,success:t,fail:n})):(\"string\"==typeof e.data&&(e.data=e.data.replace(/eval/gi,\"evaI\")),o._originRequest({url:i,header:e.contentType?{\"content-type\":e.contentType}:void 0,method:\"POST\",data:e.data,success:t,fail:n}))}},o._speedLogPipeline=E([(i={},function(e,t){if(Array.isArray(e)){var n=e.filter(function(e){var t=!i[e.url];return i[e.url]=!0,t});n.length&&t(n)}else i[e.url]||t(e),i[e.url]=!0}),P(o.config.delay),function(e,t){var n=o.config.beforeReportSpeed;if(\"function\"==typeof n&&(e=e.filter(function(e){return!1!==n(e)})),e.length)return o.lifeCycle.emit(\"beforeReportSpeed\",e),t(e)},function(e){o.send({url:\"\"+o.config.speedUrl,method:\"post\",data:function(e,t){var n={fetch:[],static:[]},i={};return Array.isArray(e)?e.forEach(function(e){n[e.type].push(e)}):n[e.type].push(e),i.payload=JSON.stringify(r({duration:n},t)),i}(e,o.bean)})}]);try{e.uin=e.uin||parseInt((document.cookie.match(/\\buin=\\D+(\\d*)/)||[])[1],10)||parseInt((document.cookie.match(/\\bilive_uin=\\D*(\\d+)/)||[])[1],10)||\"\",e.offlineLog&&o._initOfflineLog(),o.init(e,J),o.extendBean(\"sessionId\",J._sessionID)}catch(e){console.warn(e),console.log(\"%c以上错误发生在初始化 Aegis 的过程中，将会影响您正常使用 Aegis，\\n建议您联系 aegis-helper，进行反馈，感谢您的支持。\",\"color: red\"),o._sendSDKError(e)}return o}function B(){this.constructor=q}function X(e){var o,s,f=this,t=void 0===e?{}:e,n=t.path,i=void 0===n?\"/.aegis.offline.log\":n,r=t.limit,a=void 0===r?2e4:r;this.offlineBuffer=[],this.ready=function(e){f.fileSystem?setTimeout(function(){e(null)},0):(e(new Error(\"getFileSystemManager file\")),f.offlineLog=!1)},this.insertLog=(o=null,s=[],function(e){s=s.concat(e),o=o||setTimeout(function(){o=null;var e=f,t=e.fileSystem,n=e._filePath,i=s.map(function(e){return JSON.stringify(e)}).join(\"\\n\")+\"\\n\";if(i){var r=function(e){e?f.checkLimit(i,function(){s=[]}):t.writeFile({data:i,filePath:n,encoding:\"utf8\",fail:function(e){console.error(e)},success:function(){s=[]}})};t.access({path:n,success:function(){r(!0)},fail:function(){r()}})}},2e3)}),this.addLogs=function(e){f.fileSystem&&f.insertLog(e)},this.clearLogs=function(){var e=f,t=e.fileSystem,n=e._filePath;t.writeFile({filePath:n,data:\"\",fail:function(){t.unlinkSync(n)}})},this.save2Offline=function(e,t){Array.isArray(e)||(e=[e]);var n=e.map(function(e){return\"string\"==typeof e&&(e={msg:e}),A({id:t.id,uin:t.uin,time:Date.now()-0,version:t.version,from:I()},e)});f.fileSystem?f.insertLog(n):(f.fileSystem||f.offlineBuffer.length||f.ready(function(e){e?console.error(e):f.offlineBuffer.length&&(f.addLogs(f.offlineBuffer),f.offlineBuffer=[])}),f.offlineBuffer=f.offlineBuffer.concat(n))},this._filePath=F.env.USER_DATA_PATH+i,this.fileSystem=F.getFileSystemManager(),this.limitSize=a}return M.use(function(){w.push(this._normalLogPipeline),R||(R=!0,(wx||qq).onError(function(e){var t;e&&(t={msg:e,level:f.ERROR},w.forEach(function(e){e(t)}))}))}),M.use(function(){this.config.reportApiSpeed&&(b.push(this._speedLogPipeline),_.push(this._normalLogPipeline),O||(O=!0,function(){function e(o){var s=Date.now();return n(r(r({},o),{success:function(e){try{var t={method:o.method||\"get\",url:(r=o.url,\"string\"==typeof r?r.split(\"?\")[0]||\"\":r),duration:Date.now()-s,status:0,isHttps:function(e){return/^https/.test(e)}(o.url),type:\"fetch\"};t.ret=function(e,t){try{\"string\"==typeof e&&(e=JSON.parse(e)),t&&t.ret&&(m=m.concat(t.ret));var n=Object.getOwnPropertyNames(e).filter(function(e){return-1!==m.indexOf(e.toLowerCase())});return n.length?\"\"+e[n[0]]:\"unknown\"}catch(e){return\"unknown\"}}(e.data),i=t,b.forEach(function(e){e(i)}),n={msg:\"req url: \"+t.url+\" \\nres time: \"+t.duration+\" \\nres data: \"+JSON.stringify(e.data),level:f.API_RESPONSE},_.forEach(function(e){e(n)})}catch(e){}finally{o.success&&o.success(e)}var n,i,r}}))}var t=wx||qq,n=t.request;try{Object.defineProperty(t,\"request\",{get:function(){return e}})}catch(t){console.warn(\"无法重定义`request`，无法进行CGI测速，错误详情：\",t)}}()))}),M.use(function(){var t=this;!function(e){var t=wx||qq;try{var n=t.getStorageSync(\"AEGIS_ID\");n||(n=\"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx\".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return(\"x\"==e?t:3&t|8).toString(16)}),t.setStorageSync(\"AEGIS_ID\",n)),e(n||\"\")}catch(t){e(\"\")}}(function(e){t.bean.aid=e})}),M});\n//# sourceMappingURL=aegis.min.js.map\n"]}